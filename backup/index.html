<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Management System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const warehouses = [
            { id: 1, name: 'Agogo', type: 'sub', location: 'Ghana' },
            { id: 2, name: 'Techiman', type: 'sub', location: 'Ghana' },
            { id: 3, name: 'Ashanti', type: 'sub', location: 'Ghana' },
            { id: 4, name: 'Volta', type: 'sub', location: 'Ghana' },
            { id: 5, name: 'Accra', type: 'central', location: 'Ghana' },
            { id: 6, name: 'Bolga', type: 'sub', location: 'Ghana' },
            { id: 7, name: 'Tamale', type: 'sub', location: 'Ghana' },
            { id: 8, name: 'Enchi', type: 'sub', location: 'Ghana' },
            { id: 9, name: 'Inventory Management', type: 'central', location: 'Ghana' },
            { id: 10, name: 'New Abirem and Koforidua', type: 'sub', location: 'Ghana' },
            { id: 11, name: 'Damongo', type: 'sub', location: 'Ghana' },
            { id: 12, name: 'CSIR-IIR East Legon', type: 'sub', location: 'Ghana' },
            { id: 13, name: 'Wa', type: 'sub', location: 'Ghana' },
            { id: 14, name: 'Goaso', type: 'sub', location: 'Ghana' },
            { id: 15, name: 'Ashanti1', type: 'sub', location: 'Ghana' },
            { id: 16, name: 'Sunyani', type: 'sub', location: 'Ghana' },
            { id: 17, name: 'Hohoe', type: 'sub', location: 'Ghana' },
            { id: 18, name: 'Assin Fosu', type: 'sub', location: 'Ghana' }
        ];

 // Products will be loaded from server

        const expenseCategories = [
    { id: 8, name: 'Fuel - Sales trips' },
    { id: 26, name: 'Accountancy and audit fees' },
    { id: 4, name: 'Advertisements' },
    { id: 16, name: 'Assets' },
    { id: 27, name: 'Business promotion' },
    { id: 15, name: 'Canteen - Non trip feeding' },
    { id: 22, name: 'Canteen - Trip Feeding' },
    { id: 23, name: 'Casual labour' },
    { id: 28, name: 'Cleaning and sanitation' },
    { id: 29, name: 'Conference and meetings' },
    { id: 9, name: 'DO NOT USE THIS CATEGORY' },
    { id: 30, name: 'Donations' },
    { id: 3, name: 'Electricity and water' },
    { id: 1, name: 'Employee Salary' },
    { id: 31, name: 'Foreign Travel' },
    { id: 10, name: 'Fuel - not sales trip' },
    { id: 20, name: 'HMFS' },
    { id: 7, name: 'Hotel Accomodation' },
    { id: 34, name: 'IT - internet and airtime' },
    { id: 35, name: 'IT - services' },
    { id: 33, name: 'Insurance - vehicles' },
    { id: 32, name: 'Insurance - workers and non vehicle' },
    { id: 17, name: 'Marketing' },
    { id: 36, name: 'Medicals' },
    { id: 18, name: 'MoMo Charges' },
    { id: 24, name: 'Office supplies' },
    { id: 5, name: 'Others' },
    { id: 11, name: 'Packaging' },
    { id: 37, name: 'Printing and stationary' },
    { id: 39, name: 'Registration and licensing (OFA)' },
    { id: 2, name: 'Rent storerooms and facilities' },
    { id: 40, name: 'Repairs and maintenance - non vehicles' },
    { id: 6, name: 'Returnable' },
    { id: 44, name: 'Subscriptions' },
    { id: 43, name: 'Subscriptions' },
    { id: 42, name: 'Training and Development Staff' },
    { id: 38, name: 'Transport' },
    { id: 21, name: 'Transport of OFA' },
    { id: 14, name: 'Travel' },
    { id: 25, name: 'Uniform' },
    { id: 19, name: 'Vehicle' },
    { id: 13, name: 'Vehicle licences and insurance' },
    { id: 12, name: 'Vehicle repairs and maintenance' }
];
        
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [warehousePermissions, setWarehousePermissions] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [stock, setStock] = useState({});
            const [movements, setMovements] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [waybills, setWaybills] = useState([]);
            const [products, setProducts] = useState([]);
            const [selectedWaybill, setSelectedWaybill] = useState(null);
            const [newProductName, setNewProductName] = useState('');
            const [newProductSku, setNewProductSku] = useState('');
            const [editingProduct, setEditingProduct] = useState(null);
            const [newProductPrice, setNewProductPrice] = useState('');
            //activity log
            const [activityLog, setActivityLog] = useState([]);
            const [activityFilter, setActivityFilter] = useState('all');
            // Invoice states
            const [invoices, setInvoices] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [selectedInvoice, setSelectedInvoice] = useState(null);
            const [invoiceCustomer, setInvoiceCustomer] = useState('');
            const [invoiceWarehouse, setInvoiceWarehouse] = useState('');
            const [invoiceItems, setInvoiceItems] = useState([{ productId: '', quantity: '', unitPrice: '', discount: 0, isSample: false, sampleNotes: '' }]);
            const [invoiceDate, setInvoiceDate] = useState('');
            const [invoiceDueDate, setInvoiceDueDate] = useState('');
            const [invoicePaymentPlan, setInvoicePaymentPlan] = useState('Full Payment');
            const [invoicePaymentMethod, setInvoicePaymentMethod] = useState('');
            const [invoiceSalesRep, setInvoiceSalesRep] = useState('');
            const [paymentAmount, setPaymentAmount] = useState('');
            const [invoiceAttachments, setInvoiceAttachments] = useState([]);
           // User management states
            const [allUsers, setAllUsers] = useState([]);
            const [selectedUser, setSelectedUser] = useState(null);
            const [newUsername, setNewUsername] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [newName, setNewName] = useState('');
            const [newRole, setNewRole] = useState('warehouse');
            const [newFinanceAdmin, setNewFinanceAdmin] = useState(false);
            const [newWarehouseAccess, setNewWarehouseAccess] = useState([]);
           
            // Transaction states
            const [txType, setTxType] = useState('create');
            const [txWarehouse, setTxWarehouse] = useState('');
            const [txProduct, setTxProduct] = useState('');
            const [txQuantity, setTxQuantity] = useState('');
            const [txFromWarehouse, setTxFromWarehouse] = useState('');
            const [txToWarehouse, setTxToWarehouse] = useState('');
            const [txNotes, setTxNotes] = useState('');
            
            // Expense states
            const [expenseTitle, setExpenseTitle] = useState('');
            const [expenseDescription, setExpenseDescription] = useState('');
            const [expenseAmount, setExpenseAmount] = useState('');
            const [expenseCategory, setExpenseCategory] = useState('');
            const [expenseDate, setExpenseDate] = useState('');
            const [expenseFiles, setExpenseFiles] = useState([]);
            const [selectedExpense, setSelectedExpense] = useState(null);
            const [paymentMethod, setPaymentMethod] = useState('');
            const [paymentReference, setPaymentReference] = useState('');
            
            useEffect(() => {
                if (currentUser) {
                    fetchData();
                }
            }, [currentUser]);
            
            const fetchData = async () => {
                const stockData = await fetch('/api/stock').then(r => r.json());
                const movementsData = await fetch('/api/movements').then(r => r.json());
                const expensesData = await fetch('/api/expenses').then(r => r.json());
                const invoicesData = await fetch('/api/invoices').then(r => r.json());
                const customersData = await fetch('/api/customers').then(r => r.json());
                const usersData = await fetch('/api/users').then(r => r.json());
                const waybillsData = await fetch('/api/waybills').then(r => r.json());
                const productsData = await fetch('/api/products').then(r => r.json());
                const activityLogData = await fetch('/api/activity-log').then(r => r.json());
                const warehousePermissionsData = await fetch('/api/warehouse-permissions'). then(r => r,json());
                setStock(stockData);
                setMovements(movementsData);
                setExpenses(expensesData);
                setInvoices(invoicesData);
                setCustomers(customersData);
                setAllUsers(usersData);
                setWaybills(waybillsData);
                setProducts(productsData);
                setActivityLog(activityLogData);
                setWarehousePermissions(warehousePermissionsData);
            };
            
            const handleLogin = async () => {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: loginUsername, password: loginPassword })
                });
                const data = await response.json();
                
                if (data.success) {
                    setCurrentUser(data.user);
                    setLoginError('');
                } else {
                    setLoginError('Invalid credentials');
                }
            };
            
            const handleLogout = async () => {
                await fetch('/api/logout', { method: 'POST' });
                setCurrentUser(null);
            };
            
            const getStock = (whId, prodId) => stock[whId + '-' + prodId] || 0;
            const calculateTotals = () => {
                const totals = {};
                const accessibleWarehouses = currentUser && currentUser.warehouseAccess === 'all' 
                    ? warehouses 
                    : currentUser && Array.isArray(currentUser.warehouseAccess)
                    ? warehouses.filter(wh => currentUser.warehouseAccess.includes(wh.id))
                    : warehouses;
                
                products.forEach(prod => {
                    totals[prod.id] = accessibleWarehouses.reduce((sum, wh) => {
                        return sum + getStock(wh.id, prod.id);
                    }, 0);
                });
                return totals;
            };            
            const getAccessibleWarehouses = () => {
                if (!currentUser) return [];
                if (!currentUser.warehouseAccess || currentUser.warehouseAccess === 'all') return warehouses;
                if (Array.isArray(currentUser.warehouseAccess)) {
                    return warehouses.filter(wh => currentUser.warehouseAccess.includes(wh.id));
                }
                return warehouses;
            };

            
            const handleTransaction = async () => {
                if (!txQuantity || parseInt(txQuantity) <= 0) {
                    alert('Please enter a valid quantity');
                    return;
                }
                
                const qty = parseInt(txQuantity);
                let updateData = { quantity: qty };
                
                if (txType === 'create') {
                    if (!txWarehouse || !txProduct) {
                        alert('Please select warehouse and product');
                        return;
                    }
                    const whId = parseInt(txWarehouse);
                    const prodId = parseInt(txProduct);
                    const wh = warehouses.find(w => w.id === whId);
                    const prod = products.find(p => p.id === prodId);
                    
                    await fetch('/api/stock/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            warehouseId: whId, 
                            productId: prodId, 
                            quantity: qty,
                            userId: currentUser.id,
                            userName: currentUser.name 
                        })
                    });
                    
                    await fetch('/api/movements', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'create',
                            warehouseName: wh.name,
                            productName: prod.name,
                            quantity: qty,
                            notes: txNotes,
                            user: currentUser.name,
                            userId: currentUser.id
                        })
                    });
                    
                } else if (txType === 'remove') {
                    if (!txWarehouse || !txProduct) {
                        alert('Please select warehouse and product');
                        return;
                    }
                    const whId = parseInt(txWarehouse);
                    const prodId = parseInt(txProduct);
                    
                    if (getStock(whId, prodId) < qty) {
                        alert('Insufficient stock!');
                        return;
                    }
                    
                    const wh = warehouses.find(w => w.id === whId);
                    const prod = products.find(p => p.id === prodId);
                    
                    await fetch('/api/stock/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ warehouseId: whId, productId: prodId, quantity: -qty })
                    });
                    
                    await fetch('/api/movements', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'remove',
                            warehouseName: wh.name,
                            productName: prod.name,
                            quantity: qty,
                            notes: txNotes,
                            user: currentUser.name,
                            userId: currentUser.id
                        })
                    });
                    
                } else if (txType === 'transfer') {
                    if (!txFromWarehouse || !txToWarehouse || !txProduct) {
                        alert('Please select warehouses and product');
                        return;
                    }
                    const fromId = parseInt(txFromWarehouse);
                    const toId = parseInt(txToWarehouse);
                    const prodId = parseInt(txProduct);
                    
                    if (getStock(fromId, prodId) < qty) {
                        alert('Insufficient stock in source warehouse!');
                        return;
                    }
                    
                    const fromWh = warehouses.find(w => w.id === fromId);
                    const toWh = warehouses.find(w => w.id === toId);
                    const prod = products.find(p => p.id === prodId);
                    
                    // Remove from source warehouse (put in transit)
                    await fetch('/api/stock/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ warehouseId: fromId, productId: prodId, quantity: -qty })
                    });
                    
                    // Create waybill
                    await fetch('/api/waybills', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fromWarehouseId: fromId,
                            fromWarehouseName: fromWh.name,
                            toWarehouseId: toId,
                            toWarehouseName: toWh.name,
                            productId: prodId,
                            productName: prod.name,
                            quantity: qty,
                            notes: txNotes,
                            issuedBy: currentUser.name,
                            issuedById: currentUser.id
                        })
                    });
                    
                    await fetch('/api/movements', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'transfer-initiated',
                            fromWarehouseName: fromWh.name,
                            toWarehouseName: toWh.name,
                            productName: prod.name,
                            quantity: qty,
                            notes: txNotes,
                            user: currentUser.name
                        })
                    });
                }
                
                await fetchData();
                setTxQuantity('');
                setTxNotes('');
                setTxWarehouse('');
                setTxProduct('');
                setTxFromWarehouse('');
                setTxToWarehouse('');
                alert('Transaction recorded successfully!');
            };
            
const submitExpense = async () => {
    if (!expenseTitle || !expenseAmount || !expenseCategory || !expenseDate) {
        alert('Please fill in all required fields');
        return;
    }
    
    await fetch('/api/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: expenseTitle,
            description: expenseDescription,
            amount: parseFloat(expenseAmount),
            category: expenseCategory,
            dateIncurred: expenseDate,
            requestedBy: currentUser.name,
            requestedById: currentUser.id,
            files: expenseFiles
        })
    });
    
    await fetchData();
    setExpenseTitle('');
    setExpenseDescription('');
    setExpenseAmount('');
    setExpenseCategory('');
    setExpenseDate('');
    setExpenseFiles([]);
    setSelectedExpense(null);
    alert('Expense submitted successfully!');
};
            
            const approveExpense = async (expenseId) => {
                await fetch(`/api/expenses/${expenseId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        approvedBy: currentUser.name, 
                        approvedById: currentUser.id})
                });
                await fetchData();
                setSelectedExpense(null);
                alert('Expense approved!');
            };
            
           const markAsPaid = async (expenseId) => {
                if (!paymentMethod) {
                    alert('Please enter payment method');
                    return;
                }
                
                await fetch(`/api/expenses/${expenseId}/pay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processedBy: currentUser.name,
                        processedById: currentUser.id,
                        paymentMethod,
                        paymentReference
                    })
                });
                await fetchData();
                setSelectedExpense(null);
                setPaymentMethod('');
                setPaymentReference('');
                alert('Expense marked as paid!');
            };

const createInvoice = async () => {
    if (!invoiceCustomer || !invoiceWarehouse || invoiceItems.length === 0) {
        alert('Please fill in customer, warehouse, and at least one item');
        return;
    }

    // Validate that all items have required fields
    for (let i = 0; i < invoiceItems.length; i++) {
        const item = invoiceItems[i];
        if (!item.productId || !item.quantity || (item.unitPrice === '' && !item.isSample)) {
            alert(`Please complete all fields for item ${i + 1}`);
            return;
        }
    }

    const customer = customers.find(c => c.id === parseInt(invoiceCustomer));
    const warehouse = warehouses.find(w => w.id === parseInt(invoiceWarehouse));

    const items = invoiceItems.map(item => {
        const product = products.find(p => p.id === parseInt(item.productId));
        const quantity = parseInt(item.quantity);
        const unitPrice = item.isSample ? 0 : parseFloat(item.unitPrice);
        const discount = item.isSample ? 0 : (parseFloat(item.discount) || 0);
        const total = (quantity * unitPrice) - discount;
        
        return {
            productId: item.productId,
            productName: product.name,
            quantity: quantity,
            unitPrice: unitPrice,
            discount: discount,
            total: total,
            isSample: item.isSample || false,
            sampleNotes: item.sampleNotes || ''
        };
    });

    const subtotal = items.reduce((sum, item) => sum + item.total, 0);
    
    await fetch('/api/invoices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            customerId: invoiceCustomer,
            customerName: customer.name,
            customerPhone: customer.phone,
            customerAddress: customer.address,
            warehouseId: invoiceWarehouse,
            warehouseName: warehouse.name,
            items: items,
            subtotal: subtotal,
            total: subtotal,
            invoiceDate: invoiceDate,
            dueDate: invoiceDueDate || null,
            paymentPlan: invoicePaymentPlan,
            paymentMethod: invoicePaymentMethod,
            salesRep: invoiceSalesRep,
            createdBy: currentUser.name,
            createdById: currentUser.id,
            attachments: invoiceAttachments
        })
    });

    await fetchData();
    setInvoiceCustomer('');
    setInvoiceWarehouse('');
    setInvoiceItems([{ productId: '', quantity: '', unitPrice: '', discount: 0, isSample: false, sampleNotes: '' }]);
    setInvoiceDate(new Date().toISOString().split('T')[0]);
    setInvoiceDueDate('');
    setInvoicePaymentPlan('Full Payment');
    setInvoicePaymentMethod('');
    setInvoiceSalesRep('');
    setInvoiceAttachments([]);
    setSelectedInvoice(null);
    alert('Invoice created successfully!');
};

    const recordPayment = async (invoiceId) => {
        if (!paymentAmount || parseFloat(paymentAmount) <= 0) {
            alert('Please enter a valid payment amount');
            return;
        }
        
        await fetch(`/api/invoices/${invoiceId}/payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: parseFloat(paymentAmount),
                method: paymentMethod,
                recordedBy: currentUser.name,
                recordedById: currentUser.id
            })
        });
        
        await fetchData();
        setPaymentAmount('');
        setPaymentMethod('Cash');
        alert('Payment recorded successfully!');
    };

    const removeInvoiceItem = (index) => {
        setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
    };

    const updateInvoiceItem = (index, field, value) => {
        const newItems = [...invoiceItems];
        
        if (field === 'productId') {
            const product = products.find(p => p.id === parseInt(value));
            newItems[index][field] = value;
            // Auto-fill unit price from product
            if (product && !newItems[index].isSample) {
                newItems[index].unitPrice = product.price || '';
            }
        } else if (field === 'isSample') {
            newItems[index][field] = value;
            // Set price to 0 if sample
            if (value) {
                newItems[index].unitPrice = 0;
                newItems[index].discount = 0;
            } else {
                // Restore product price if not sample
                const product = products.find(p => p.id === parseInt(newItems[index].productId));
                if (product) {
                    newItems[index].unitPrice = product.price || '';
                }
            }
        } else {
            newItems[index][field] = value;
        }
        
        setInvoiceItems(newItems);
    };

    const addInvoiceItem = () => {
        setInvoiceItems([...invoiceItems, { productId: '', quantity: '', unitPrice: '', discount: 0, isSample: false, sampleNotes: '' }]);
    };

    
        

        


    
        


   
    const createUser = async () => {
                    if (!newUsername || !newPassword || !newName) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: newUsername,
                            password: newPassword,
                            name: newName,
                            role: newRole,
                            financeAdmin: newFinanceAdmin,
                            warehouseAccess: newWarehouseAccess.length > 0 ? newWarehouseAccess : 'all'
                        })
                    });
                    
                    await fetchData();
                    setNewUsername('');
                    setNewPassword('');
                    setNewName('');
                    setNewRole('warehouse');
                    setNewFinanceAdmin(false);
                    setNewWarehouseAccess([]);
                    setSelectedUser(null);
                    alert('User created successfully!');
                };

                const updateUser = async (userId) => {
                    const user = allUsers.find(u => u.id === userId);
                    
                    await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: user.name,
                            role: user.role,
                            financeAdmin: user.financeAdmin,
                            warehouseAccess: user.warehouseAccess
                        })
                    });
                    
                    await fetchData();
                    setSelectedUser(null);
                    alert('User updated successfully!');
                };

                const deleteUser = async (userId) => {
                    if (!confirm('Are you sure you want to delete this user?')) return;
                    
                    await fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    });
                    
                    await fetchData();
                    alert('User deleted successfully!');
                };

                const productTotals = calculateTotals();
            
            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                            <div className="flex items-center justify-center mb-6">
                                <svg className="w-12 h-12 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                <h1 className="text-3xl font-bold text-gray-800">Warehouse System</h1>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input
                                        type="text"
                                        value={loginUsername}
                                        onChange={(e) => setLoginUsername(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <div className="relative">
                                        <input
                                            type={showPassword ? "text" : "password"}
                                            value={loginPassword}
                                            onChange={(e) => setLoginPassword(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                        <button
                                            type="button"
                                            onClick={() => setShowPassword(!showPassword)}
                                            className="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700"
                                        >
                                            {showPassword ? '👁️' : '👁️‍🗨️'}
                                        </button>
                                    </div>
                                </div>
                                
                                {loginError && <div className="text-red-600 text-sm">{loginError}</div>}
                                
                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition-colors"
                                >
                                    Login
                                </button>
                            </div>
                            
                            <div className="mt-6 p-4 bg-gray-50 rounded-md text-sm text-gray-600">
                                <p className="font-semibold mb-2">Demo Credentials:</p>
                                <p>Admin: admin / admin123</p>
                                <p>Warehouse: wh1 / pass123</p>
                                <p>Finance: finance / pass123</p>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="bg-indigo-600 text-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold">Warehouse Management System</h1>
                                <p className="text-indigo-200 text-sm">Logged in as: {currentUser.name}</p>
                            </div>
                            <button
                                onClick={handleLogout}
                                className="bg-indigo-700 px-4 py-2 rounded-md hover:bg-indigo-800 transition-colors"
                            >
                                Logout
                            </button>
                        </div>
                    </header>

                    <nav className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex space-x-8">
                              {['dashboard', 'stock', 'transactions', 'history', 'expenses', 'invoices', 'waybills', ...(currentUser.role === 'admin' ? ['products', 'permissions', 'activity-log', 'users'] : [])].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={'px-4 py-4 border-b-2 transition-colors ' + (activeTab === tab ? 'border-indigo-600 text-indigo-600 font-semibold' : 'border-transparent text-gray-600 hover:text-gray-900')}
                                    >
                                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-1">Welcome, {currentUser.name.split(' ')[0]}!</h2>
                                    <p className="text-gray-600">Here is what is happening in your business.</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    {products.slice(0, 2).map((product, index) => {
                                        const colors = ['indigo', 'green'];
                                        const color = colors[index] || 'blue';
                                        return (
                                            <div key={product.id} className="bg-white rounded-lg shadow p-6">
                                                <h3 className="text-sm font-medium text-gray-600 mb-2">Total {product.name}</h3>
                                                <p className={`text-3xl font-bold text-${color}-600`}>{(productTotals[product.id] || 0).toLocaleString()}</p>
                                                <p className="text-xs text-gray-500 mt-1">Across all warehouses</p>
                                            </div>
                                        );
                                    })}

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-sm font-medium text-gray-600 mb-2">Warehouses</h3>
                                        <p className="text-3xl font-bold text-purple-600">{getAccessibleWarehouses().length}</p>
                                        <p className="text-xs text-gray-500 mt-1">Active locations</p>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-sm font-medium text-gray-600 mb-2">Total Expenses</h3>
                                        <p className="text-3xl font-bold text-blue-600">{expenses.length}</p>
                                        <p className="text-xs text-gray-500 mt-1">All time</p>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="text-lg font-bold text-gray-800 mb-4">Recent Activity</h3>
                                    {movements.length === 0 ? (
                                        <p className="text-center py-8 text-gray-500">No recent activity</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {movements.slice(0, 5).map(movement => (
                                                <div key={movement.id} className="flex items-center justify-between py-2 border-b">
                                                    <div className="flex-1">
                                                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full mr-2 ' + (movement.type === 'create' ? 'bg-green-100 text-green-800' : movement.type === 'remove' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800')}>
                                                            {movement.type.toUpperCase()}
                                                        </span>
                                                        <span className="text-sm text-gray-800">
                                                            {movement.type === 'transfer' ? 
                                                                `${movement.quantity} × ${movement.productName} from ${movement.fromWarehouseName} to ${movement.toWarehouseName}` :
                                                                `${movement.quantity} × ${movement.productName} ${movement.type === 'create' ? 'created at' : 'removed from'} ${movement.warehouseName}`
                                                            }
                                                        </span>
                                                    </div>
                                                    <span className="text-xs text-gray-500">{new Date(movement.timestamp).toLocaleTimeString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stock' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-6">Current Stock Levels</h2>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="bg-gray-50 border-b-2">
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Warehouse</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Location</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Type</th>
                                                <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">1L Bottles</th>
                                                <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700">5L Bottles</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getAccessibleWarehouses().map(warehouse => (
                                                <tr key={warehouse.id} className="border-b hover:bg-gray-50">
                                                    <td className="px-4 py-3 text-sm font-medium text-gray-900">{warehouse.name}</td>
                                                    <td className="px-4 py-3 text-sm text-gray-600">{warehouse.location}</td>
                                                    <td className="px-4 py-3">
                                                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + (warehouse.type === 'central' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800')}>
                                                            {warehouse.type}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-right text-sm font-semibold text-gray-800">{getStock(warehouse.id, 1)}</td>
                                                    <td className="px-4 py-3 text-right text-sm font-semibold text-gray-800">{getStock(warehouse.id, 2)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Record Transaction</h2>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <button
                                                onClick={() => setTxType('create')}
                                                className={'px-4 py-3 rounded-md border-2 transition-colors ' + (txType === 'create' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-300 bg-white hover:bg-gray-50')}
                                            >
                                                Create Stock
                                            </button>
                                            <button
                                                onClick={() => setTxType('remove')}
                                                className={'px-4 py-3 rounded-md border-2 transition-colors ' + (txType === 'remove' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-300 bg-white hover:bg-gray-50')}
                                            >
                                                Remove Stock
                                            </button>
                                            <button
                                                onClick={() => setTxType('transfer')}
                                                className={'px-4 py-3 rounded-md border-2 transition-colors ' + (txType === 'transfer' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-300 bg-white hover:bg-gray-50')}
                                            >
                                                Transfer
                                            </button>
                                        </div>
                                    </div>

                                    {txType === 'transfer' ? (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">From Warehouse</label>
                                                <select
                                                    value={txFromWarehouse}
                                                    onChange={(e) => setTxFromWarehouse(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                >
                                                    <option value="">Select...</option>
                                                    {getAccessibleWarehouses().map(wh => (
                                                        <option key={wh.id} value={wh.id}>{wh.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">To Warehouse</label>
                                                <select
                                                    value={txToWarehouse}
                                                    onChange={(e) => setTxToWarehouse(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                >
                                                    <option value="">Select...</option>
                                                    {getAccessibleWarehouses().map(wh => (
                                                        <option key={wh.id} value={wh.id}>{wh.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Warehouse</label>
                                            <select
                                                value={txWarehouse}
                                                onChange={(e) => setTxWarehouse(e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                            >
                                                <option value="">Select warehouse...</option>
                                                {getAccessibleWarehouses().map(w => (
                                                    <option key={w.id} value={w.id}>{w.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Product</label>
<select
value={txProduct}
onChange={(e) => setTxProduct(e.target.value)}
className="w-full px-3 py-2 border border-gray-300 rounded-md"
>
<option value="">Select product...</option>
{products.map(prod => (
<option key={prod.id} value={prod.id}>{prod.name}</option>
))}
</select>
</div>
<div>
<label className="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
<input
type="number"
min="1"
value={txQuantity}
onChange={(e) => setTxQuantity(e.target.value)}
className="w-full px-3 py-2 border border-gray-300 rounded-md"
/>
</div>
</div>
<div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                                    <textarea
                                        value={txNotes}
                                        onChange={(e) => setTxNotes(e.target.value)}
                                        rows="2"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        placeholder="Add notes..."
                                    />
                                </div>

                                <button
                                    onClick={handleTransaction}
                                    className={'w-full py-3 rounded-md text-white font-semibold ' + (txType === 'create' ? 'bg-green-600 hover:bg-green-700' : txType === 'remove' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700')}
                                >
                                    {txType === 'create' ? 'Create Stock' : txType === 'remove' ? 'Remove Stock' : 'Transfer Stock'}
                                </button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'history' && (
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Movement History</h2>
                            {movements.length === 0 ? (
                                <p className="text-center py-12 text-gray-500">No movements recorded yet</p>
                            ) : (
                                <div className="space-y-3">
                                    {movements.map(movement => (
                                        <div key={movement.id} className="border border-gray-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <span className={'inline-flex px-3 py-1 text-xs font-semibold rounded-full ' + (movement.type === 'create' ? 'bg-green-100 text-green-800' : movement.type === 'remove' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800')}>
                                                    {movement.type.toUpperCase()}
                                                </span>
                                                <span className="ml-3 text-sm text-gray-600">
                                                    {new Date(movement.timestamp).toLocaleString()}
                                                </span>
                                            </div>
                                            <div className="text-sm text-gray-800">
                                                {movement.type === 'transfer' ? (
                                                    <p>
                                                        <span className="font-semibold">{movement.quantity}</span> × {movement.productName} from{' '}
                                                        <span className="font-semibold">{movement.fromWarehouseName}</span> to{' '}
                                                        <span className="font-semibold">{movement.toWarehouseName}</span>
                                                    </p>
                                                ) : (
                                                    <p>
                                                        <span className="font-semibold">{movement.quantity}</span> × {movement.productName}{' '}
                                                        {movement.type === 'create' ? 'created at' : 'removed from'}{' '}
                                                        <span className="font-semibold">{movement.warehouseName}</span>
                                                    </p>
                                                )}
                                            </div>
                                            {movement.notes && (
                                                <p className="text-sm text-gray-600 mt-1 italic">{movement.notes}</p>
                                            )}
                                            <p className="text-xs text-gray-500 mt-2">By: {movement.user}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'expenses' && !selectedExpense && (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h2 className="text-xl font-bold text-gray-800">Expenses</h2>
                                <button
                                    onClick={() => setSelectedExpense('new')}
                                    className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
                                >
                                    + New Expense
                                </button>
                            </div>
                            <div className="bg-white rounded-lg shadow">
                                <table className="w-full">
                                    <thead>
                                        <tr className="bg-gray-50 border-b">
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Title</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Category</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Amount</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Requested By</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {expenses.length === 0 ? (
                                            <tr>
                                                <td colSpan="7" className="px-4 py-8 text-center text-gray-500">No expenses yet</td>
                                            </tr>
                                        ) : (
                                            expenses.filter(expense => {
                                                // Finance admins and admins see all expenses
                                                if (currentUser.financeAdmin || currentUser.role === 'admin') return true;
                                                // Regular users only see their own expenses
                                                return expense.requestedById === currentUser.id;
                                            }).map(expense => (
                                                <tr key={expense.id} className="border-b hover:bg-gray-50">
                                                    <td className="px-4 py-3 text-sm">{expense.title}</td>
                                                    <td className="px-4 py-3 text-sm">
                                                        <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-cyan-100 text-cyan-800">
                                                            {expense.category}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm">GHS {expense.amount.toFixed(2)}</td>
                                                    <td className="px-4 py-3 text-sm">{expense.requestedBy}</td>
                                                    <td className="px-4 py-3 text-sm">{new Date(expense.dateIncurred).toLocaleDateString()}</td>
                                                    <td className="px-4 py-3 text-sm">
                                                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + (expense.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' : expense.status === 'approved' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800')}>
                                                            {expense.status.charAt(0).toUpperCase() + expense.status.slice(1)}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm">
                                                        <button
                                                            onClick={() => setSelectedExpense(expense)}
                                                            className="text-indigo-600 hover:text-indigo-900 font-medium"
                                                        >
                                                            View
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'expenses' && selectedExpense === 'new' && (
                        <div className="bg-white rounded-lg shadow p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-gray-800">New Expense</h2>
                                <button
                                    onClick={() => setSelectedExpense(null)}
                                    className="text-gray-600 hover:text-gray-900"
                                >
                                    ✕ Close
                                </button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input
                                        type="text"
                                        value={expenseTitle}
                                        onChange={(e) => setExpenseTitle(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        placeholder="e.g., Accommodation"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={expenseDescription}
                                        onChange={(e) => setExpenseDescription(e.target.value)}
                                        rows="3"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        placeholder="Details about this expense..."
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Amount (GHS)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            value={expenseAmount}
                                            onChange={(e) => setExpenseAmount(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Date Incurred</label>
                                        <input
                                            type="date"
                                            value={expenseDate}
                                            onChange={(e) => setExpenseDate(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        />
                                    </div>
                                </div>

                                <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">Category *</label>
    <select
        value={expenseCategory}
        onChange={(e) => setExpenseCategory(e.target.value)}
        className="w-full px-3 py-2 border border-gray-300 rounded-md"
    >
        <option value="">Select category...</option>
        {expenseCategories.map(cat => (
            <option key={cat.id} value={cat.name}>{cat.name}</option>
        ))}
    </select>
</div>

<div>
    <label className="block text-sm font-medium text-gray-700 mb-1">Supporting Documents (up to 5 files)</label>
    <input
        type="file"
        multiple
        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
        onChange={(e) => {
            const files = Array.from(e.target.files).slice(0, 5);
            const fileNames = files.map(f => f.name);
            setExpenseFiles(fileNames);
        }}
        className="w-full px-3 py-2 border border-gray-300 rounded-md"
    />
    <p className="text-xs text-gray-500 mt-1">Max 5 files (PDF, JPG, PNG, DOC, DOCX)</p>
    {expenseFiles.length > 0 && (
        <div className="mt-2">
            <p className="text-sm font-medium text-gray-700">Selected files:</p>
            <ul className="text-xs text-gray-600 list-disc list-inside">
                {expenseFiles.map((file, idx) => (
                    <li key={idx}>{file}</li>
                ))}
            </ul>
        </div>
    )}
</div>

                                <div className="flex space-x-3">
                                    <button
                                        onClick={submitExpense}
                                        className="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700"
                                    >
                                        Submit Expense
                                    </button>
                                    <button
                                        onClick={() => setSelectedExpense(null)}
                                        className="px-6 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'expenses' && selectedExpense && selectedExpense !== 'new' && (
                        <div className="bg-white rounded-lg shadow p-6">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-xl font-bold text-gray-800">Expense Details</h2>
                                <button
                                    onClick={() => setSelectedExpense(null)}
                                    className="text-gray-600 hover:text-gray-900"
                                >
                                    ✕ Close
                                </button>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Title</p>
                                        <p className="text-gray-900">{selectedExpense.title}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Status</p>
                                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + (selectedExpense.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' : selectedExpense.status === 'approved' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800')}>
                                            {selectedExpense.status.charAt(0).toUpperCase() + selectedExpense.status.slice(1)}
                                        </span>
                                    </div>
                                </div>

                                <div>
                                    <p className="text-sm font-medium text-gray-600">Description</p>
                                    <p className="text-gray-900">{selectedExpense.description || 'No description'}</p>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Amount</p>
                                        <p className="text-gray-900">GHS {selectedExpense.amount.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Date Incurred</p>
                                        <p className="text-gray-900">{new Date(selectedExpense.dateIncurred).toLocaleDateString()}</p>
                                    </div>
                                </div>

                                <div>
                                    <p className="text-sm font-medium text-gray-600">Category</p>
                                    <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-cyan-100 text-cyan-800">
                                        {selectedExpense.category}
                                    </span>
                                </div>
                                {selectedExpense.files && selectedExpense.files.length > 0 && (
                                     <div>
                                        <p className="text-sm font-medium text-gray-600 mb-2">Attached Files ({selectedExpense.files.length})</p>
                                        <ul className="text-sm text-gray-700 list-disc list-inside">
                                             {selectedExpense.files.map((file, idx) => (
                                                 <li key={idx}>{file}</li>
                                              ))}
                                         </ul>
                                     </div>
                                )}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Requested By</p>
                                        <p className="text-gray-900">{selectedExpense.requestedBy}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Submission Date</p>
                                        <p className="text-gray-900">{new Date(selectedExpense.submissionDate).toLocaleDateString()}</p>
                                    </div>
                                </div>

                                {selectedExpense.approvedBy && (
                                    <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                                        <p className="font-semibold text-blue-900 mb-2">Approval Information</p>
                                        <p className="text-sm text-blue-800">Approved by: {selectedExpense.approvedBy}</p>
                                        <p className="text-sm text-blue-800">Date: {new Date(selectedExpense.approvalDate).toLocaleDateString()}</p>
                                    </div>
                                )}

                                {selectedExpense.processedBy && (
                                    <div className="mt-4 p-4 bg-green-50 rounded-lg">
                                        <p className="font-semibold text-green-900 mb-2">Payment Information</p>
                                        <p className="text-sm text-green-800">Processed by: {selectedExpense.processedBy}</p>
                                        <p className="text-sm text-green-800">Date: {new Date(selectedExpense.paymentDate).toLocaleDateString()}</p>
                                        <p className="text-sm text-green-800">Method: {selectedExpense.paymentMethod}</p>
                                        {selectedExpense.paymentReference && (
                                            <p className="text-sm text-green-800">Reference: {selectedExpense.paymentReference}</p>
                                        )}
                                    </div>
                                )}
                            </div>

                            {currentUser.financeAdmin && selectedExpense.status === 'submitted' && (
                                <div className="mt-6 pt-6 border-t">
                                    <button
                                        onClick={() => approveExpense(selectedExpense.id)}
                                        className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                                    >
                                        ✓ Approve Expense
                                    </button>
                                </div>
                            )}

                            {currentUser.financeAdmin && selectedExpense.status === 'approved' && (
                                <div className="mt-6 pt-6 border-t">
                                    <h3 className="text-sm font-medium text-gray-700 mb-3">Mark as Paid</h3>
                                    <div className="space-y-3">
                                        <input
                                            type="text"
                                            placeholder="Payment method (e.g., Bank transfer)"
                                            value={paymentMethod}
                                            onChange={(e) => setPaymentMethod(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        />
                                        <input
                                            type="text"
                                            placeholder="Reference number (optional)"
                                            value={paymentReference}
                                            onChange={(e) => setPaymentReference(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        />
                                        <button
                                            onClick={() => markAsPaid(selectedExpense.id)}
                                            className="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700"
                                        >
                                            ✓ Mark as Paid
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                  {activeTab === 'invoices' && !selectedInvoice && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Invoices</h2>
            <button
                onClick={() => setSelectedInvoice('new')}
                className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
            >
                + New Invoice
            </button>
        </div>

        <div className="grid grid-cols-4 gap-4">
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Total Invoices</h3>
                <p className="text-2xl font-bold text-gray-900">{invoices.length}</p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Unpaid</h3>
                <p className="text-2xl font-bold text-red-600">{invoices.filter(i => i.status === 'unpaid').length}</p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Partial</h3>
                <p className="text-2xl font-bold text-yellow-600">{invoices.filter(i => i.status === 'partial').length}</p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Paid</h3>
                <p className="text-2xl font-bold text-green-600">{invoices.filter(i => i.status === 'paid').length}</p>
            </div>
        </div>

        <div className="bg-white rounded-lg shadow">
            <table className="w-full">
                <thead>
                    <tr className="bg-gray-50 border-b">
                        <th className="px-4 py-3 text-left text-sm font-semibold">Invoice #</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Warehouse</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Issue Date</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Total</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Paid</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Balance</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {invoices.length === 0 ? (
                        <tr>
                            <td colSpan="9" className="px-4 py-8 text-center text-gray-500">No invoices yet</td>
                        </tr>
                    ) : (
                        invoices.filter(invoice => {
                            // Admins see all invoices
                            if (currentUser.role === 'admin' || currentUser.warehouseAccess === 'all') return true;
                            // Warehouse users only see invoices from their warehouses
                            return currentUser.warehouseAccess.includes(parseInt(invoice.warehouseId));
                        }).map(invoice => {
                            const totalPaid = (invoice.payments || []).reduce((sum, p) => sum + p.amount, 0);
                            const balance = invoice.total - totalPaid;
                            return (
                                <tr key={invoice.id} className="border-b hover:bg-gray-50">
                                    <td className="px-4 py-3 text-sm font-medium">{invoice.invoiceNumber}</td>
                                    <td className="px-4 py-3 text-sm">{invoice.customerName}</td>
                                    <td className="px-4 py-3 text-sm">{invoice.warehouseName}</td>
                                    <td className="px-4 py-3 text-sm">{new Date(invoice.issueDate).toLocaleDateString()}</td>
                                    <td className="px-4 py-3 text-sm text-right">GHS {invoice.total.toFixed(2)}</td>
                                    <td className="px-4 py-3 text-sm text-right">GHS {totalPaid.toFixed(2)}</td>
                                    <td className="px-4 py-3 text-sm text-right font-semibold text-red-600">GHS {balance.toFixed(2)}</td>
                                    <td className="px-4 py-3 text-sm">
                                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + 
                                            (invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 
                                             invoice.status === 'partial' ? 'bg-yellow-100 text-yellow-800' : 
                                             'bg-red-100 text-red-800')}>
                                            {invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-sm">
                                        <button
                                            onClick={() => setSelectedInvoice(invoice)}
                                            className="text-indigo-600 hover:text-indigo-900 font-medium"
                                        >
                                            View
                                        </button>
                                    </td>
                                </tr>
                            );
                        })
                    )}
                </tbody>
            </table>
        </div>
    </div>
)}

{activeTab === 'invoices' && selectedInvoice === 'new' && (
    <div className="bg-white rounded-lg shadow p-6">
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-gray-800">New Invoice</h2>
            <button
                onClick={() => {
                    setSelectedInvoice(null);
                    setInvoiceItems([{ productId: '', quantity: '', unitPrice: '', discount: 0, isSample: false, sampleNotes: '' }]);
                    setInvoiceDate(new Date().toISOString().split('T')[0]);
                    setInvoiceDueDate('');
                    setInvoicePaymentPlan('Full Payment');
                }}
                className="text-gray-600 hover:text-gray-900"
            >
                ✕ Close
            </button>
        </div>

        <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                    <select
                        value={invoiceCustomer}
                        onChange={(e) => setInvoiceCustomer(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                        <option value="">Select customer...</option>
                        {customers.map(c => (
                            <option key={c.id} value={c.id}>{c.name}</option>
                        ))}
                    </select>
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Warehouse *</label>
                    <select
                        value={invoiceWarehouse}
                        onChange={(e) => setInvoiceWarehouse(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                        <option value="">Select warehouse...</option>
                        {getAccessibleWarehouses().map(w => (
                            <option key={w.id} value={w.id}>{w.name}</option>
                        ))}
                    </select>
                </div>
            </div>

            <div className="grid grid-cols-4 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Date *</label>
                    <input
                        type="date"
                        value={invoiceDate}
                        onChange={(e) => setInvoiceDate(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    <input
                        type="date"
                        value={invoiceDueDate}
                        onChange={(e) => setInvoiceDueDate(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                    <p className="text-xs text-gray-500 mt-1">Leave blank for cash sales</p>
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Payment Plan *</label>
                    <select
                        value={invoicePaymentPlan}
                        onChange={(e) => setInvoicePaymentPlan(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                        <option value="Full Payment">Full Payment</option>
                        <option value="Half Now, Half Later">Half Now, Half Later</option>
                        <option value="Custom Installments">Custom Installments</option>
                    </select>
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Sales Rep</label>
                    <input
                        type="text"
                        value={invoiceSalesRep}
                        onChange={(e) => setInvoiceSalesRep(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                        placeholder="Sales representative"
                    />
                </div>
            </div>

            <div className="border-t pt-4">
                <div className="flex justify-between items-center mb-3">
                    <label className="block text-sm font-medium text-gray-700">Order Items *</label>
                    <button
                        onClick={addInvoiceItem}
                        className="text-indigo-600 hover:text-indigo-900 text-sm font-medium"
                    >
                        + Add Item
                    </button>
                </div>
                
                {invoiceItems.map((item, index) => (
                    <div key={index} className="mb-4 p-4 border border-gray-200 rounded-lg">
                        <div className="grid grid-cols-6 gap-2 mb-2">
                            <div className="col-span-2">
                                <label className="block text-xs text-gray-600 mb-1">Product</label>
                                <select
                                    value={item.productId}
                                    onChange={(e) => updateInvoiceItem(index, 'productId', e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                    disabled={item.isSample}
                                >
                                    <option value="">Select product...</option>
                                    {products.map(p => (
                                        <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs text-gray-600 mb-1">Quantity</label>
                                <input
                                    type="number"
                                    placeholder="Qty"
                                    value={item.quantity}
                                    onChange={(e) => updateInvoiceItem(index, 'quantity', e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-600 mb-1">Unit Price</label>
                                <input
                                    type="number"
                                    placeholder="Price"
                                    value={item.unitPrice}
                                    onChange={(e) => updateInvoiceItem(index, 'unitPrice', e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                    disabled={item.isSample}
                                />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-600 mb-1">Discount</label>
                                <input
                                    type="number"
                                    placeholder="Discount"
                                    value={item.discount}
                                    onChange={(e) => updateInvoiceItem(index, 'discount', e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                    disabled={item.isSample}
                                />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-600 mb-1">Line Total</label>
                                <div className="px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm font-semibold">
                                    GHS {((parseFloat(item.quantity) || 0) * (parseFloat(item.unitPrice) || 0) - (parseFloat(item.discount) || 0)).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4 mt-2">
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={item.isSample}
                                    onChange={(e) => updateInvoiceItem(index, 'isSample', e.target.checked)}
                                    className="mr-2"
                                />
                                <span className="text-sm text-gray-700">Sample Given</span>
                            </label>
                            
                            {item.isSample && (
                                <div className="flex-1">
                                    <input
                                        type="text"
                                        placeholder="Sample notes..."
                                        value={item.sampleNotes}
                                        onChange={(e) => updateInvoiceItem(index, 'sampleNotes', e.target.value)}
                                        className="w-full px-3 py-1 border border-gray-300 rounded-md text-sm"
                                    />
                                </div>
                            )}
                            
                            {invoiceItems.length > 1 && (
                                <button
                                    onClick={() => removeInvoiceItem(index)}
                                    className="px-3 py-1 bg-red-100 text-red-600 rounded-md text-sm hover:bg-red-200"
                                >
                                    Remove
                                </button>
                            )}
                        </div>
                        
                        {item.isSample && (
                            <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                ⚠️ Samples will be deducted from inventory at zero cost
                            </div>
                        )}
                    </div>
                ))}
            </div>

            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Attachments (up to 5 files)</label>
                <input
                    type="file"
                    multiple
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    onChange={(e) => {
                        const files = Array.from(e.target.files).slice(0, 5);
                        const fileNames = files.map(f => f.name);
                        setInvoiceAttachments(fileNames);
                    }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
                <p className="text-xs text-gray-500 mt-1">Max 5 files (PDF, JPG, PNG, DOC, DOCX)</p>
                {invoiceAttachments.length > 0 && (
                    <div className="mt-2">
                        <p className="text-sm font-medium text-gray-700">Attached files:</p>
                        <ul className="text-xs text-gray-600 list-disc list-inside">
                            {invoiceAttachments.map((file, idx) => (
                                <li key={idx}>{file}</li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>

            <div className="flex space-x-3">
                <button
                    onClick={createInvoice}
                    className="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700"
                >
                    Create Invoice
                </button>
                <button
                    onClick={() => {
                        setSelectedInvoice(null);
                        setInvoiceItems([{ productId: '', quantity: '', unitPrice: '', discount: 0, isSample: false, sampleNotes: '' }]);
                        setInvoiceDate(new Date().toISOString().split('T')[0]);
                        setInvoiceDueDate('');
                        setInvoicePaymentPlan('Full Payment');
                    }}
                    className="px-6 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
)}      
{activeTab === 'waybills' && !selectedWaybill && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Waybills (Stock in Transit)</h2>
        </div>

        <div className="grid grid-cols-3 gap-4">
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">In Transit</h3>
                <p className="text-2xl font-bold text-yellow-600">{waybills.filter(w => w.status === 'in-transit').length}</p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Received</h3>
                <p className="text-2xl font-bold text-green-600">{waybills.filter(w => w.status === 'received').length}</p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm text-gray-600 mb-2">Cancelled</h3>
                <p className="text-2xl font-bold text-red-600">{waybills.filter(w => w.status === 'cancelled').length}</p>
            </div>
        </div>

        <div className="bg-white rounded-lg shadow">
            <table className="w-full">
                <thead>
                    <tr className="bg-gray-50 border-b">
                        <th className="px-4 py-3 text-left text-sm font-semibold">Waybill #</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">From</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">To</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Product</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Quantity</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Issue Date</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Status</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {waybills.length === 0 ? (
                        <tr>
                            <td colSpan="8" className="px-4 py-8 text-center text-gray-500">No waybills yet</td>
                        </tr>
                    ) : (
                        waybills.filter(waybill => {
                            // Admins see all waybills
                            if (currentUser.role === 'admin' || currentUser.warehouseAccess === 'all') return true;
                            // Warehouse users see waybills from/to their warehouses
                            return currentUser.warehouseAccess.includes(waybill.fromWarehouseId) || 
                                   currentUser.warehouseAccess.includes(waybill.toWarehouseId);
                        }).map(waybill => (
                            <tr key={waybill.id} className="border-b hover:bg-gray-50">
                                <td className="px-4 py-3 text-sm font-medium">{waybill.waybillNumber}</td>
                                <td className="px-4 py-3 text-sm">{waybill.fromWarehouseName}</td>
                                <td className="px-4 py-3 text-sm">{waybill.toWarehouseName}</td>
                                <td className="px-4 py-3 text-sm">{waybill.productName}</td>
                                <td className="px-4 py-3 text-sm text-right font-semibold">{waybill.quantity}</td>
                                <td className="px-4 py-3 text-sm">{new Date(waybill.issueDate).toLocaleDateString()}</td>
                                <td className="px-4 py-3 text-sm">
                                    <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + 
                                        (waybill.status === 'received' ? 'bg-green-100 text-green-800' : 
                                         waybill.status === 'cancelled' ? 'bg-red-100 text-red-800' : 
                                         'bg-yellow-100 text-yellow-800')}>
                                        {waybill.status === 'in-transit' ? 'In Transit' : 
                                         waybill.status.charAt(0).toUpperCase() + waybill.status.slice(1)}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    <button
                                        onClick={() => setSelectedWaybill(waybill)}
                                        className="text-indigo-600 hover:text-indigo-900 font-medium"
                                    >
                                        View
                                    </button>
                                </td>
                            </tr>
                        ))
                    )}
                </tbody>
            </table>
        </div>
    </div>
)}

{activeTab === 'waybills' && selectedWaybill && (
    <div className="bg-white rounded-lg shadow p-6">
        <div className="flex justify-between items-start mb-6">
            <div>
                <h2 className="text-xl font-bold text-gray-800">Waybill {selectedWaybill.waybillNumber}</h2>
                <p className="text-sm text-gray-600">Issue Date: {new Date(selectedWaybill.issueDate).toLocaleDateString()}</p>
            </div>
            <button
                onClick={() => setSelectedWaybill(null)}
                className="text-gray-600 hover:text-gray-900"
            >
                ✕ Close
            </button>
        </div>

        <div className="grid grid-cols-2 gap-6 mb-6">
            <div className="p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-800 mb-2">From Warehouse</h3>
                <p className="text-gray-900 font-medium">{selectedWaybill.fromWarehouseName}</p>
            </div>
            
            <div className="p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-800 mb-2">To Warehouse</h3>
                <p className="text-gray-900 font-medium">{selectedWaybill.toWarehouseName}</p>
            </div>
        </div>

        <div className="mb-6">
            <h3 className="font-semibold text-gray-800 mb-3">Transfer Details</h3>
            <div className="border border-gray-200 rounded-lg p-4">
                <div className="grid grid-cols-3 gap-4">
                    <div>
                        <p className="text-sm text-gray-600">Product</p>
                        <p className="font-semibold">{selectedWaybill.productName}</p>
                    </div>
                    <div>
                        <p className="text-sm text-gray-600">Quantity</p>
                        <p className="font-semibold">{selectedWaybill.quantity}</p>
                    </div>
                    <div>
                        <p className="text-sm text-gray-600">Status</p>
                        <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + 
                            (selectedWaybill.status === 'received' ? 'bg-green-100 text-green-800' : 
                             selectedWaybill.status === 'cancelled' ? 'bg-red-100 text-red-800' : 
                             'bg-yellow-100 text-yellow-800')}>
                            {selectedWaybill.status === 'in-transit' ? 'In Transit' : 
                             selectedWaybill.status.charAt(0).toUpperCase() + selectedWaybill.status.slice(1)}
                        </span>
                    </div>
                </div>
                {selectedWaybill.notes && (
                    <div className="mt-3">
                        <p className="text-sm text-gray-600">Notes</p>
                        <p className="text-gray-900">{selectedWaybill.notes}</p>
                    </div>
                )}
                <div className="mt-3">
                    <p className="text-sm text-gray-600">Issued By</p>
                    <p className="text-gray-900">{selectedWaybill.issuedBy}</p>
                </div>
            </div>
        </div>

        {selectedWaybill.receivedBy && (
            <div className="mb-6 p-4 bg-green-50 rounded-lg">
                <p className="font-semibold text-green-900 mb-2">Received</p>
                <p className="text-sm text-green-800">Received by: {selectedWaybill.receivedBy}</p>
                <p className="text-sm text-green-800">Date: {new Date(selectedWaybill.receivedDate).toLocaleDateString()}</p>
            </div>
        )}

        {selectedWaybill.cancelledBy && (
            <div className="mb-6 p-4 bg-red-50 rounded-lg">
                <p className="font-semibold text-red-900 mb-2">Cancelled</p>
                <p className="text-sm text-red-800">Cancelled by: {selectedWaybill.cancelledBy}</p>
                <p className="text-sm text-red-800">Date: {new Date(selectedWaybill.cancelledDate).toLocaleDateString()}</p>
            </div>
        )}

        {selectedWaybill.status === 'in-transit' && (
            <div className="mt-6 pt-6 border-t flex space-x-3">
                {currentUser.warehouseAccess === 'all' || currentUser.warehouseAccess.includes(selectedWaybill.toWarehouseId) ? (
                    <button
                        onClick={async () => {
                            await fetch(`/api/waybills/${selectedWaybill.id}/receive`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ receivedBy: currentUser.name })
                            });
                            await fetchData();
                            setSelectedWaybill(null);
                            alert('Waybill received! Stock added to warehouse.');
                        }}
                        className="flex-1 bg-green-600 text-white py-2 rounded-md hover:bg-green-700"
                    >
                        ✓ Receive Stock
                    </button>
                ) : null}
                {currentUser.warehouseAccess === 'all' || currentUser.warehouseAccess.includes(selectedWaybill.fromWarehouseId) ? (
                    <button
                        onClick={async () => {
                            if (!confirm('Are you sure you want to cancel this transfer? Stock will be returned to source warehouse.')) return;
                            await fetch(`/api/waybills/${selectedWaybill.id}/cancel`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ cancelledBy: currentUser.name })
                            });
                            await fetchData();
                            setSelectedWaybill(null);
                            alert('Waybill cancelled. Stock returned to source warehouse.');
                        }}
                        className="flex-1 bg-red-600 text-white py-2 rounded-md hover:bg-red-700"
                    >
                        ✕ Cancel Transfer
                    </button>
                ) : null}
            </div>
        )}
    </div>
)}
{activeTab === 'products' && currentUser.role === 'admin' && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Product Management</h2>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Add New Product</h3>
            <div className="grid grid-cols-4 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                    <input
                        type="text"
                        value={newProductName}
                        onChange={(e) => setNewProductName(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                        placeholder="e.g., 10L Bottle"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">SKU *</label>
                    <input
                        type="text"
                        value={newProductSku}
                        onChange={(e) => setNewProductSku(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                        placeholder="e.g., 10L"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Unit Price (GHS) *</label>
                    <input
                        type="number"
                        step="0.01"
                        min="0"
                        value={newProductPrice}
                        onChange={(e) => setNewProductPrice(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                        placeholder="0.00"
                    />
                </div>
                <div className="flex items-end">
                    <button
                        onClick={async () => {
                            if (!newProductName || !newProductSku) {
                                alert('Please fill in all fields');
                                return;
                            }
                            await fetch('/api/products', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: newProductName,
                                    sku: newProductSku,
                                    price: parseFloat(newProductPrice) || 0,
                                    createdById: currentUser.id,
                                    createdByName: currentUser.name
                                })
                            });
                            await fetchData();
                            setNewProductName('');
                            setNewProductSku('');
                            setNewProductPrice('');
                            alert('Product added successfully!');
                        }}
                        className="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700"
                    >
                        Add Product
                    </button>
                </div>
            </div>
        </div>

        <div className="bg-white rounded-lg shadow">
            <h3 className="text-lg font-bold text-gray-800 p-6 pb-4">Existing Products</h3>
            <table className="w-full">
                <thead>
                    <tr className="bg-gray-50 border-b">
                        <th className="px-4 py-3 text-left text-sm font-semibold">ID</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Product Name</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">SKU</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Unit Price (GHS)</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Total Stock</th>
                        <th className="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {products.map(product => {
                        const totalStock = warehouses.reduce((sum, wh) => sum + getStock(wh.id, product.id), 0);
                        const isEditing = editingProduct === product.id;
                        
                        return (
                            <tr key={product.id} className="border-b hover:bg-gray-50">
                                <td className="px-4 py-3 text-sm">{product.id}</td>
                                <td className="px-4 py-3 text-sm font-medium">{product.name}</td>
                                <td className="px-4 py-3 text-sm">
                                    <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                        {product.sku}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm text-right">
                                    {isEditing ? (
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            defaultValue={product.price}
                                            onChange={(e) => setNewProductPrice(e.target.value)}
                                            className="w-24 px-2 py-1 border border-indigo-300 rounded text-right"
                                            autoFocus
                                        />
                                    ) : (
                                        <span className="font-semibold">GHS {(product.price || 0).toFixed(2)}</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-sm text-right font-semibold">{totalStock.toLocaleString()}</td>
                                <td className="px-4 py-3 text-sm text-center">
                                    {isEditing ? (
                                        <div className="flex items-center justify-center space-x-2">
                                            <button
                                                onClick={async () => {
                                                    await fetch(`/api/products/${product.id}`, {
                                                        method: 'PUT',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({
                                                            name: product.name,
                                                            sku: product.sku,
                                                            price: parseFloat(newProductPrice) || 0,
                                                            updatedById: currentUser.id,
                                                            updatedByName: currentUser.name
                                                        })
                                                    });
                                                    await fetchData();
                                                    setEditingProduct(null);
                                                    setNewProductPrice('');
                                                    alert('Price updated successfully!');
                                                }}
                                                className="text-green-600 hover:text-green-900 font-medium"
                                            >
                                                ✓ Save
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setEditingProduct(null);
                                                    setNewProductPrice('');
                                                }}
                                                className="text-red-600 hover:text-red-900 font-medium"
                                            >
                                                ✕ Cancel
                                            </button>
                                        </div>
                                    ) : (
                                        <button
                                            onClick={() => {
                                                setEditingProduct(product.id);
                                                setNewProductPrice(product.price || 0);
                                            }}
                                            className="text-indigo-600 hover:text-indigo-900 font-medium"
                                        >
                                            Edit Price
                                        </button>
                                    )}
                                </td>
                            </tr>
                        );
                    })}
                </tbody>
            </table>
        </div>
    </div>
)}
{activeTab === 'permissions' && currentUser.role === 'admin' && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Warehouse Permissions</h2>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {warehousePermissions.map(permission => (
                <div key={permission.warehouseId} className="bg-white rounded-lg shadow p-6">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="text-lg font-bold text-gray-800">{permission.warehouseName}</h3>
                            <p className="text-sm text-gray-600">
                                {permission.userCount} {permission.userCount === 1 ? 'user' : 'users'} with access
                            </p>
                        </div>
                        {permission.manager && (
                            <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                Manager
                            </span>
                        )}
                    </div>

                    {permission.manager && (
                        <div className="mb-3 p-3 bg-purple-50 rounded-lg">
                            <p className="text-xs text-purple-600 font-semibold mb-1">Warehouse Manager</p>
                            <p className="text-sm text-purple-900">{permission.manager.name}</p>
                        </div>
                    )}

                    <div className="border-t pt-3">
                        <p className="text-xs font-semibold text-gray-600 mb-2">Users with access:</p>
                        <div className="space-y-1">
                            {permission.users.map(user => (
                                <div key={user.id} className="flex items-center justify-between py-1">
                                    <span className="text-sm text-gray-700">{user.name}</span>
                                    <span className={`inline-flex px-2 py-0.5 text-xs font-semibold rounded-full ${
                                        user.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                                        user.role === 'accountant' ? 'bg-blue-100 text-blue-800' :
                                        'bg-green-100 text-green-800'
                                    }`}>
                                        {user.role}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
)}

{activeTab === 'activity-log' && currentUser.role === 'admin' && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Activity Log</h2>
            <select
                value={activityFilter}
                onChange={(e) => setActivityFilter(e.target.value)}
                className="px-3 py-2 border border-gray-300 rounded-md"
            >
                <option value="all">All Activities</option>
                <option value="login">Logins</option>
                <option value="stock_update">Stock Updates</option>
                <option value="expense_created">Expenses Created</option>
                <option value="expense_approved">Expenses Approved</option>
                <option value="expense_paid">Expenses Paid</option>
                <option value="invoice_created">Invoices Created</option>
                <option value="payment_recorded">Payments Recorded</option>
                <option value="waybill_created">Waybills Created</option>
                <option value="waybill_received">Waybills Received</option>
                <option value="waybill_cancelled">Waybills Cancelled</option>
                <option value="user_created">Users Created</option>
                <option value="user_updated">Users Updated</option>
                <option value="user_deleted">Users Deleted</option>
                <option value="product_created">Products Created</option>
                <option value="product_updated">Products Updated</option>
            </select>
        </div>

        <div className="bg-white rounded-lg shadow">
            <table className="w-full">
                <thead>
                    <tr className="bg-gray-50 border-b">
                        <th className="px-4 py-3 text-left text-sm font-semibold">Timestamp</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">User</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Action</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Details</th>
                    </tr>
                </thead>
                <tbody>
                    {activityLog.filter(log => activityFilter === 'all' || log.action === activityFilter).length === 0 ? (
                        <tr>
                            <td colSpan="4" className="px-4 py-8 text-center text-gray-500">No activity logged yet</td>
                        </tr>
                    ) : (
                        activityLog.filter(log => activityFilter === 'all' || log.action === activityFilter).map(log => {
                            const actionColors = {
                                'login': 'bg-blue-100 text-blue-800',
                                'stock_update': 'bg-purple-100 text-purple-800',
                                'expense_created': 'bg-yellow-100 text-yellow-800',
                                'expense_approved': 'bg-blue-100 text-blue-800',
                                'expense_paid': 'bg-green-100 text-green-800',
                                'invoice_created': 'bg-indigo-100 text-indigo-800',
                                'payment_recorded': 'bg-green-100 text-green-800',
                                'waybill_created': 'bg-orange-100 text-orange-800',
                                'waybill_received': 'bg-green-100 text-green-800',
                                'waybill_cancelled': 'bg-red-100 text-red-800',
                                'user_created': 'bg-teal-100 text-teal-800',
                                'user_updated': 'bg-cyan-100 text-cyan-800',
                                'user_deleted': 'bg-red-100 text-red-800',
                                'product_created': 'bg-lime-100 text-lime-800',
                                'product_updated': 'bg-amber-100 text-amber-800'
                            };
                            
                            const actionLabels = {
                                'login': 'Login',
                                'stock_update': 'Stock Update',
                                'expense_created': 'Expense Created',
                                'expense_approved': 'Expense Approved',
                                'expense_paid': 'Expense Paid',
                                'invoice_created': 'Invoice Created',
                                'payment_recorded': 'Payment Recorded',
                                'waybill_created': 'Waybill Created',
                                'waybill_received': 'Waybill Received',
                                'waybill_cancelled': 'Waybill Cancelled',
                                'user_created': 'User Created',
                                'user_updated': 'User Updated',
                                'user_deleted': 'User Deleted',
                                'product_created': 'Product Created',
                                'product_updated': 'Product Updated'
                            };
                            
                            return (
                                <tr key={log.id} className="border-b hover:bg-gray-50">
                                    <td className="px-4 py-3 text-sm text-gray-600">
                                        {new Date(log.timestamp).toLocaleString()}
                                    </td>
                                    <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                        {log.userName}
                                    </td>
                                    <td className="px-4 py-3 text-sm">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${actionColors[log.action] || 'bg-gray-100 text-gray-800'}`}>
                                            {actionLabels[log.action] || log.action}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-sm text-gray-700">
                                        {log.details}
                                    </td>
                                </tr>
                            );
                        })
                    )}
                </tbody>
            </table>
        </div>
    </div>
)}
{activeTab === 'users' && currentUser.role === 'admin' && (
    <div className="space-y-6">
        <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">User Management</h2>
            <button
                onClick={() => setSelectedUser('new')}
                className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
            >
                + New User
            </button>
        </div>

        <div className="bg-white rounded-lg shadow">
            <table className="w-full">
                <thead>
                    <tr className="bg-gray-50 border-b">
                        <th className="px-4 py-3 text-left text-sm font-semibold">Username</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Name</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Role</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Finance Admin</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Warehouse Access</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {allUsers.map(user => (
                        <tr key={user.id} className="border-b hover:bg-gray-50">
                            <td className="px-4 py-3 text-sm font-medium">{user.username}</td>
                            <td className="px-4 py-3 text-sm">{user.name}</td>
                            <td className="px-4 py-3 text-sm">
                                <span className={'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + 
                                    (user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 
                                     user.role === 'finance' ? 'bg-blue-100 text-blue-800' : 
                                     'bg-green-100 text-green-800')}>
                                    {user.role}
                                </span>
                            </td>
                            <td className="px-4 py-3 text-sm">{user.financeAdmin ? '✓ Yes' : '✗ No'}</td>
                            <td className="px-4 py-3 text-sm">
                                {user.warehouseAccess === 'all' ? (
                                    <span className="font-semibold text-indigo-600">All Warehouses</span>
                                ) : (
                                    <span>{user.warehouseAccess.map(wId => warehouses.find(w => w.id === wId)?.name).join(', ')}</span>
                                )}
                            </td>
                            <td className="px-4 py-3 text-sm space-x-2">
                                <button
                                    onClick={() => setSelectedUser(user)}
                                    className="text-indigo-600 hover:text-indigo-900 font-medium"
                                >
                                    Edit
                                </button>
                                {user.id !== currentUser.id && (
                                    <button
                                        onClick={() => deleteUser(user.id)}
                                        className="text-red-600 hover:text-red-900 font-medium"
                                    >
                                        Delete
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    </div>
)}

{selectedUser === 'new' && (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-800">Create New User</h3>
                <button onClick={() => setSelectedUser(null)} className="text-gray-600 hover:text-gray-900">✕</button>
            </div>
            
            <div className="space-y-3">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                    <input
                        type="text"
                        value={newUsername}
                        onChange={(e) => setNewUsername(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input
                        type="password"
                        value={newPassword}
                        onChange={(e) => setNewPassword(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input
                        type="text"
                        value={newName}
                        onChange={(e) => setNewName(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select
                        value={newRole}
                        onChange={(e) => setNewRole(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                        <option value="warehouse">Warehouse User</option>
                        <option value="finance">Finance</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        checked={newFinanceAdmin}
                        onChange={(e) => setNewFinanceAdmin(e.target.checked)}
                        className="mr-2"
                    />
                    <label className="text-sm text-gray-700">Finance Admin (can approve/pay expenses)</label>
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Warehouse Access</label>
                    <div className="border border-gray-300 rounded-md p-3 max-h-48 overflow-y-auto">
                        <div className="mb-2">
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={newWarehouseAccess.length === 0}
                                    onChange={(e) => {
                                        if (e.target.checked) {
                                            setNewWarehouseAccess([]);
                                        }
                                    }}
                                    className="mr-2"
                                />
                                <span className="text-sm font-semibold text-indigo-600">All Warehouses</span>
                            </label>
                        </div>
                        <div className="border-t pt-2 mt-2">
                            {warehouses.map(wh => (
                                <label key={wh.id} className="flex items-center mb-1">
                                    <input
                                        type="checkbox"
                                        checked={newWarehouseAccess.includes(wh.id)}
                                        onChange={(e) => {
                                            if (e.target.checked) {
                                                setNewWarehouseAccess([...newWarehouseAccess, wh.id]);
                                            } else {
                                                setNewWarehouseAccess(newWarehouseAccess.filter(id => id !== wh.id));
                                            }
                                        }}
                                        className="mr-2"
                                    />
                                    <span className="text-sm">{wh.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
                
                <div className="flex space-x-3 pt-3">
                    <button
                        onClick={createUser}
                        className="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700"
                    >
                        Create User
                    </button>
                    <button
                        onClick={() => setSelectedUser(null)}
                        className="px-6 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
)}

{selectedUser && selectedUser !== 'new' && (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-800">Edit User: {selectedUser.username}</h3>
                <button onClick={() => setSelectedUser(null)} className="text-gray-600 hover:text-gray-900">✕</button>
            </div>
            
            <div className="space-y-3">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Warehouse Access</label>
                    <div className="border border-gray-300 rounded-md p-3 max-h-48 overflow-y-auto">
                        <div className="mb-2">
                            <label className="flex items-center">
                                <input
                                    type="checkbox"
                                    checked={selectedUser.warehouseAccess === 'all'}
                                    onChange={(e) => {
                                        if (e.target.checked) {
                                            setAllUsers(allUsers.map(u => 
                                                u.id === selectedUser.id ? {...u, warehouseAccess: 'all'} : u
                                            ));
                                        }
                                    }}
                                    className="mr-2"
                                />
                                <span className="text-sm font-semibold text-indigo-600">All Warehouses</span>
                            </label>
                        </div>
                        <div className="border-t pt-2 mt-2">
                            {warehouses.map(wh => (
                                <label key={wh.id} className="flex items-center mb-1">
                                    <input
                                        type="checkbox"
                                        checked={selectedUser.warehouseAccess !== 'all' && selectedUser.warehouseAccess.includes(wh.id)}
                                        onChange={(e) => {
                                            const currentAccess = selectedUser.warehouseAccess === 'all' ? [] : selectedUser.warehouseAccess;
                                            let newAccess;
                                            if (e.target.checked) {
                                                newAccess = [...currentAccess, wh.id];
                                            } else {
                                                newAccess = currentAccess.filter(id => id !== wh.id);
                                            }
                                            setAllUsers(allUsers.map(u => 
                                                u.id === selectedUser.id ? {...u, warehouseAccess: newAccess.length > 0 ? newAccess : 'all'} : u
                                            ));
                                        }}
                                        className="mr-2"
                                    />
                                    <span className="text-sm">{wh.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
                
                <div className="flex space-x-3 pt-3">
                    <button
                        onClick={() => updateUser(selectedUser.id)}
                        className="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700"
                    >
                        Save Changes
                    </button>
                    <button
                        onClick={() => setSelectedUser(null)}
                        className="px-6 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
)}
                </main>
            </div>
        );
        }   
    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>